{"version":3,"file":"answervalidation.min.js","sources":["../src/answervalidation.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * On-the-fly validation for student input to Formulas questions.\n *\n * @module     qtype_formulas/answervalidation\n * @copyright  2025 Philipp Imhof\n * @author     Philipp Imhof\n * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport {call as fetchMany} from 'core/ajax';\nimport {latexify} from 'qtype_formulas/latexify';\nimport {notifyFilterContentUpdated} from 'core_filters/events';\n\n/**\n * Array to store all pending timers, allowing to reset / cancel them.\n */\nvar timers = [];\n\n/**\n * Delay (in milliseconds) before sending the current input of a field to validation.\n */\nconst DELAY = 200;\n\n/**\n * Initialisation, i. e. attaching event handlers to the input fields.\n */\nexport const init = () => {\n    let inputs = document.getElementsByTagName('input');\n\n    for (let input of inputs) {\n        // First make sure the input belongs to our qtype. We only have text fields and\n        // they all have a 'formulas_' class, e. g. 'formulas_number_unit'.\n        if (input.type !== 'text' || !input.className.match('formulas_')) {\n            continue;\n        }\n\n        // Also, we do not validate unit fields.\n        if (input.dataset.answertype == 'unit') {\n            continue;\n        }\n\n        // Attach event listener for the input event.\n        input.addEventListener('input', setDebounceTimer);\n    }\n};\n\n/**\n * Send student input to the web service for validation and show or hide the warning symbol\n * depending on the result.\n *\n * @param {string} id form field's id\n */\nconst validateStudentAnswer = async(id) => {\n    let field = document.getElementById(id);\n    let symbol = document.getElementById(`warning-${id}`);\n\n    // Empty fields must not be validated and should not have a warning symbol.\n    if (field.value === '') {\n        symbol.style.visibility = 'hidden';\n        return;\n    }\n\n    let pendingPromise = new Pending('qtype_formulas/validatestudentanswer');\n    try {\n        let validationResult = await fetchMany([{\n            methodname: 'qtype_formulas_validate_student_answer',\n            args: {\n                'answer': field.value,\n                'answertype': field.dataset.answertype,\n                'withunit': field.dataset.withunit,\n            },\n        }])[0];\n        symbol.style.visibility = (validationResult ? 'hidden' : 'visible');\n        if (validationResult) {\n            let texcode = await latexify(field.value);\n            showMathJax(id, texcode);\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n\n    pendingPromise.resolve();\n};\n\nconst showMathJax = (id, texcode) => {\n    let field = document.getElementById(id);\n\n    let div = document.createElement('div');\n    div.classList.add('formulas_input_info');\n    div.classList.add('filter_mathjaxloader_equation');\n    field.parentNode.insertBefore(div, field);\n\n    div.innerHTML = `\\\\( ${texcode} \\\\)`;\n\n    // Tell the MathJax filter that we have added some content to be rendered.\n    notifyFilterContentUpdated(div.parentNode);\n};\n\n/**\n * Event handler: set or re-initialize timer for a given input field.\n *\n * @param {Event} evt event\n */\nconst setDebounceTimer = (evt) => {\n    // If a timer has already been set, delete it.\n    if (typeof timers[evt.target.id] === 'number') {\n        clearTimeout(timers[evt.target.id]);\n    }\n    // Set timer for given input field.\n    timers[evt.target.id] = setTimeout(validateStudentAnswer, DELAY, evt.target.id);\n};\n\nexport default {init};\n"],"names":["timers","init","inputs","document","getElementsByTagName","input","type","className","match","dataset","answertype","addEventListener","setDebounceTimer","validateStudentAnswer","async","field","getElementById","id","symbol","value","style","visibility","pendingPromise","Pending","validationResult","methodname","args","withunit","texcode","showMathJax","err","Notification","exception","resolve","div","createElement","classList","add","parentNode","insertBefore","innerHTML","evt","target","clearTimeout","setTimeout"],"mappings":";;;;;;;;kFAiCIA,OAAS,SAUAC,KAAO,SACZC,OAASC,SAASC,qBAAqB,aAEtC,IAAIC,SAASH,OAGK,SAAfG,MAAMC,MAAoBD,MAAME,UAAUC,MAAM,cAKpB,QAA5BH,MAAMI,QAAQC,YAKlBL,MAAMM,iBAAiB,QAASC,4CAUlCC,sBAAwBC,MAAAA,SACtBC,MAAQZ,SAASa,eAAeC,IAChCC,OAASf,SAASa,iCAA0BC,QAG5B,KAAhBF,MAAMI,kBACND,OAAOE,MAAMC,WAAa,cAI1BC,eAAiB,IAAIC,iBAAQ,gDAEzBC,uBAAyB,cAAU,CAAC,CACpCC,WAAY,yCACZC,KAAM,QACQX,MAAMI,iBACFJ,MAAMN,QAAQC,oBAChBK,MAAMN,QAAQkB,aAE9B,MACJT,OAAOE,MAAMC,WAAcG,iBAAmB,SAAW,UACrDA,iBAAkB,KACdI,cAAgB,sBAASb,MAAMI,OACnCU,YAAYZ,GAAIW,UAEtB,MAAOE,KACLC,aAAaC,UAAUF,KAG3BR,eAAeW,WAGbJ,YAAc,CAACZ,GAAIW,eACjBb,MAAQZ,SAASa,eAAeC,IAEhCiB,IAAM/B,SAASgC,cAAc,OACjCD,IAAIE,UAAUC,IAAI,uBAClBH,IAAIE,UAAUC,IAAI,iCAClBtB,MAAMuB,WAAWC,aAAaL,IAAKnB,OAEnCmB,IAAIM,wBAAmBZ,uDAGIM,IAAII,aAQ7B1B,iBAAoB6B,MAEe,iBAA1BzC,OAAOyC,IAAIC,OAAOzB,KACzB0B,aAAa3C,OAAOyC,IAAIC,OAAOzB,KAGnCjB,OAAOyC,IAAIC,OAAOzB,IAAM2B,WAAW/B,sBAxFzB,IAwFuD4B,IAAIC,OAAOzB,kBAGjE,CAAChB,KAAAA"}