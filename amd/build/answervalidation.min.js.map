{"version":3,"file":"answervalidation.min.js","sources":["../src/answervalidation.js"],"sourcesContent":["// This file is part of Moodle - https://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <https://www.gnu.org/licenses/>.\n\n/**\n * On-the-fly validation for student input to Formulas questions.\n *\n * @module     qtype_formulas/answervalidation\n * @copyright  2025 Philipp Imhof\n * @author     Philipp Imhof\n * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport * as Notification from 'core/notification';\nimport Pending from 'core/pending';\nimport {call as fetchMany} from 'core/ajax';\nimport {latexify} from 'qtype_formulas/latexify';\nimport {notifyFilterContentUpdated} from 'core_filters/events';\nimport {eventTypes as filterEventTypes} from 'core_filters/events';\n\n/**\n * Array to store pending timer, allowing to reset / cancel it.\n */\nvar timer = null;\n\n/**\n * Delay (in milliseconds) before sending the current input of a field to validation.\n */\nconst DELAY = 200;\n\n/**\n * Initialisation, i. e. attaching event handlers to the input fields.\n */\nexport const init = () => {\n    // We will trigger MathJax to make sure it is initialized very early.\n    if (typeof window.MathJax === 'undefined') {\n        forceInitMathJax();\n    }\n\n    let inputs = document.getElementsByTagName('input');\n    for (let input of inputs) {\n        // First make sure the input belongs to our qtype. We only have text fields and\n        // they all have a 'formulas_' class, e. g. 'formulas_number_unit'.\n        if (input.type !== 'text' || !input.className.match('formulas_')) {\n            continue;\n        }\n\n        // Also, we do not currently validate unit fields.\n        if (input.dataset.answertype == 'unit') {\n            continue;\n        }\n\n        // Attach event listener for the input event.\n        input.addEventListener('input', setDebounceTimer);\n\n        // Attach event listener for the focus and blur events.\n        input.addEventListener('focus', focusReceived);\n        input.addEventListener('blur', hideMathJax);\n    }\n\n    // If we have a recent version of Moodle, the MathJax filter will notify us when our LaTex is\n    // rendered.\n    if (typeof filterEventTypes.filterContentRenderingComplete !== 'undefined') {\n        document.addEventListener(filterEventTypes.filterContentRenderingComplete, handleRenderingComplete);\n    } else {\n        addLegacyMathJaxListener();\n    }\n};\n\nconst focusReceived = (evt) => {\n    let field = evt.target;\n\n    // If the field is empty, there is nothing to do.\n    if (field.value == '') {\n        return;\n    }\n\n    // If the field is not empty and we already have a MathJax display for this\n    // field, we can simply reactivate it.\n    let div = document.getElementById('qtype_formulas_mathjax_display');\n    if (div !== null && div.dataset.for == field.id) {\n        div.style.visibility = 'visible';\n        return;\n    }\n\n    // In all other cases, we have to process the field's content again and recreate\n    // the MathJax preview.\n    validateStudentAnswer(field.id);\n};\n\nconst forceInitMathJax = () => {\n    if (typeof window.MathJax === 'undefined') {\n        notifyFilterContentUpdated(document.querySelector('body'));\n        setTimeout(forceInitMathJax, 200);\n    }\n};\n\nconst addLegacyMathJaxListener = () => {\n    if (typeof window.MathJax === 'undefined') {\n        setTimeout(addLegacyMathJaxListener, 200);\n    } else {\n        window.MathJax.Hub.Register.MessageHook('New Math', handleRenderingComplete);\n    }\n};\n\nconst handleRenderingComplete = (evt) => {\n    let mathjaxSpan = null;\n\n    // For older Moodle versions, we get an array of two strings. The first string\n    // is just 'New Math' (message type), the second is 'MathJax-Element-xxx' indicating\n    // the name of the new element.\n    // For more recent versions, we get an event. The nodes will be stored in the array\n    // in evt.detail.nodes.\n    if (Array.isArray(evt)) {\n        let id = evt[1];\n        mathjaxSpan = document.querySelector(`span#${id}-Frame`);\n    } else if (evt instanceof CustomEvent) {\n        for (let element of evt.detail.nodes) {\n            // Iterate until we find our preview <div>.\n            if (element.id === 'qtype_formulas_mathjax_display') {\n                mathjaxSpan = document.querySelector('span[id^=MathJax-Element-][id$=Frame]');\n                break;\n            }\n        }\n    }\n    let width = 0;\n    if (mathjaxSpan !== null) {\n        width = mathjaxSpan.getBoundingClientRect().width;\n    }\n    let div = document.getElementById('qtype_formulas_mathjax_display');\n    if (div !== null) {\n        let style = window.getComputedStyle(div);\n        width += 3 * parseInt(style.padding);\n        let maxWidth = div.parentNode.getBoundingClientRect().width;\n        width = Math.min(width, maxWidth);\n        div.style.width = width + 'px';\n    }\n};\n\n/**\n * Send student input to the web service for validation and show or hide the warning symbol\n * depending on the result.\n *\n * @param {string} id form field's id\n */\nconst validateStudentAnswer = async(id) => {\n    let field = document.getElementById(id);\n\n    // Empty fields do not have to be validated and must not be marked as invalid.\n    // If the MathJax preview is currently shown, it must be hidden.\n    if (field.value === '') {\n        field.classList.remove('is-invalid');\n        hideMathJax();\n        return;\n    }\n\n    let pendingPromise = new Pending('qtype_formulas/validatestudentanswer');\n    try {\n        let validationResult = await fetchMany([{\n            methodname: 'qtype_formulas_validate_student_answer',\n            args: {\n                'answer': field.value,\n                'answertype': field.dataset.answertype,\n                'withunit': field.dataset.withunit,\n            },\n        }])[0];\n        if (validationResult) {\n            field.classList.remove('is-invalid');\n            let texcode = await latexify(field.value);\n            showMathJax(id, texcode);\n        } else {\n            field.classList.add('is-invalid');\n            hideMathJax();\n        }\n    } catch (err) {\n        Notification.exception(err);\n    }\n\n    pendingPromise.resolve();\n};\n\nconst hideMathJax = () => {\n    let div = document.getElementById('qtype_formulas_mathjax_display');\n    if (div !== null) {\n        div.style.visibility = 'hidden';\n    }\n};\n\nconst showMathJax = (id, texcode) => {\n    let field = document.getElementById(id);\n\n    // If the field does not have focus anymore, we stop here.\n    if (document.activeElement.id !== id) {\n        return;\n    }\n\n    let div = document.getElementById('qtype_formulas_mathjax_display');\n    // If the div exists, but does not belong to our input field, delete it.\n    if (div !== null && div.dataset.for !== id) {\n        div.remove();\n        div = null;\n    }\n\n    // If there is no div (or no div anymore), create one.\n    if (div === null) {\n        div = document.createElement('div');\n        div.id = 'qtype_formulas_mathjax_display';\n        div.classList.add('filter_mathjaxloader_equation');\n        div.dataset.for = id;\n        div.style.left = field.offsetLeft + 'px';\n        field.parentNode.insertBefore(div, field.nextSibling);\n    }\n\n    div.innerText = `\\\\(\\\\displaystyle ${texcode} \\\\)`;\n    div.style.visibility = 'visible';\n\n    // Tell the MathJax filter that we have added some content to be rendered.\n    notifyFilterContentUpdated(div.parentNode);\n};\n\n/**\n * Event handler: set or re-initialize timer for a given input field.\n *\n * @param {Event} evt event\n */\nconst setDebounceTimer = (evt) => {\n    // If a timer has already been set, delete it.\n    if (typeof timer === 'number') {\n        clearTimeout(timer);\n    }\n    // Set timer for given input field.\n    timer = setTimeout(validateStudentAnswer, DELAY, evt.target.id);\n};\n\nexport default {init};\n"],"names":["timer","init","window","MathJax","forceInitMathJax","inputs","document","getElementsByTagName","input","type","className","match","dataset","answertype","addEventListener","setDebounceTimer","focusReceived","hideMathJax","filterEventTypes","filterContentRenderingComplete","handleRenderingComplete","addLegacyMathJaxListener","evt","field","target","value","div","getElementById","for","id","validateStudentAnswer","style","visibility","querySelector","setTimeout","Hub","Register","MessageHook","mathjaxSpan","Array","isArray","CustomEvent","element","detail","nodes","width","getBoundingClientRect","getComputedStyle","parseInt","padding","maxWidth","parentNode","Math","min","async","classList","remove","pendingPromise","Pending","methodname","args","withunit","texcode","showMathJax","add","err","Notification","exception","resolve","activeElement","createElement","left","offsetLeft","insertBefore","nextSibling","innerText","clearTimeout"],"mappings":"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"}