define("qtype_formulas/instantiation",["exports","core/notification","core/str","core/pending","core/ajax","core_filters/events","qtype_formulas/tabulator"],(function(_exports,Notification,String,_pending,_ajax,_events,_tabulator){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * Helper functions to check instantiation of variables
   *
   * @module     qtype_formulas/instantiation
   * @copyright  2022 Philipp Imhof
   * @author     Philipp Imhof
   * @license    https://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.default=void 0,Notification=_interopRequireWildcard(Notification),String=_interopRequireWildcard(String),_pending=(obj=_pending)&&obj.__esModule?obj:{default:obj};var numberOfParts=0;const extendTabulator=()=>{_tabulator.TabulatorFull.extendModule("columnCalcs","calculations",{stats:values=>{var count=0,min=1/0,max=-1/0,sum=0;for(let value of values)sum+=parseFloat(value),min=Math.min(min,value),max=Math.max(max,value),count++;return min===max?["","",""]:count>0&&!isNaN(sum)?[(sum/count).toFixed(1),min,max]:["","",""]}})},initTable=()=>{new _tabulator.TabulatorFull("#varsdata_display",{selectable:1,movableColumns:!0,pagination:"local",paginationSize:10,paginationButtonCount:0,columns:[{title:"#",field:"id"}],langs:{default:{pagination:{first:"⏮",last:"⏭",prev:"⏪",next:"⏩"}}}}).on("rowSelected",previewQuestionWithDataset)},quoteNonNumericValue=value=>{if(!isNaN(value))return value;if(value.startsWith("[")){let quotedElements=[],elements=(value=value.substring(1,value.length-1)).split(/\s*,\s*/);for(let element of elements)quotedElements.push(quoteNonNumericValue(element));return"["+quotedElements.join(", ")+"]"}return'"'.concat(value,'"')},fetchTextFromEditor=id=>void 0!==window.tinyMCE&&null!==window.tinyMCE.get(id)?window.tinyMCE.get(id).getContent():document.getElementById(id).value,previewQuestionWithDataset=async row=>{if(row.getElement().classList.contains("tabulator-calcs"))return;let data=row.getData(),questionvars="",partvars=Array(numberOfParts).fill("");for(let varname in data)if(varname.match(/^(random|global)_/)&&(questionvars+=varname.replace(/^(random|global)_([^*]+)\*?$/,"$2")+"=",questionvars+=quoteNonNumericValue(data[varname])+";"),varname.match(/^part_(\d+)_/)){if(varname.match(/^part_(\d+)__/))continue;let index=parseInt(varname.replace(/^part_(\d+)_.*$/,"$1"));partvars[index]+=varname.replace(/^part_(\d+)_([^*]+)\*?$/,"$2")+"=",partvars[index]+=quoteNonNumericValue(data[varname])+";"}let parttexts=[];for(let i=0;i<numberOfParts;i++)parttexts[i]=fetchTextFromEditor("id_subqtext_".concat(i));let pendingPromise=new _pending.default("qtype_formulas/questionpreview");try{let renderedTexts=await(0,_ajax.call)([{methodname:"qtype_formulas_render_question_text",args:{questiontext:fetchTextFromEditor("id_questiontext"),parttexts:parttexts,globalvars:questionvars,partvars:partvars}}])[0];showRenderedQuestionAndParts(renderedTexts)}catch(err){Notification.exception(err)}pendingPromise.resolve()},showRenderedQuestionAndParts=data=>{let div=document.getElementById("qtextpreview_display");div.innerHTML=data.question;for(let text of data.parts)div.innerHTML+=text;(0,_events.notifyFilterContentUpdated)(div.parentNode)},localizeColumnGroupNames=async()=>{let partStringRequests=[];for(let i=0;i<numberOfParts;i++)partStringRequests.push({key:"answerno",component:"qtype_formulas",param:i+1});let strings=null,pendingPromise=new _pending.default("qtype_formulas/localization");try{strings=await String.get_strings([{key:"varsrandom",component:"qtype_formulas"},{key:"varsglobal",component:"qtype_formulas"},...partStringRequests])}catch(err){Notification.exception(err)}if(pendingPromise.resolve(),null===strings)return;let columnGroups=document.querySelectorAll("div.tabulator-col-group"),i=1;for(let group of columnGroups)"Random variables"!=group.getAttribute("aria-title")?"Global variables"!=group.getAttribute("aria-title")?(setTitleForColumnGroup(group,strings[1+i]),i++):setTitleForColumnGroup(group,strings[1]):setTitleForColumnGroup(group,strings[0])},setTitleForColumnGroup=(element,title)=>{element.setAttribute("aria-title",title),element.querySelector("div.tabulator-col-title").innerText=title},fillTable=data=>{let allRows=[],rowCounter=0;for(let row of data){let thisRow={id:++rowCounter};for(let thisVar of row.randomvars)thisRow["random_".concat(thisVar.name)]=thisVar.value;for(let thisVar of row.globalvars)thisRow["global_".concat(thisVar.name)]=thisVar.value;let partCounter=0;for(let thisPart of row.parts){for(let thisVar of thisPart)thisRow["part_".concat(partCounter,"_").concat(thisVar.name)]=thisVar.value;partCounter++}allRows.push(thisRow)}_tabulator.TabulatorFull.findTable("#varsdata_display")[0].setData(allRows)};var _default={init:noParts=>{numberOfParts=noParts,extendTabulator(),initTable()},instantiate:async()=>{let howMany=document.getElementById("id_numdataset").value,localvars=[],answers=[];for(let i=0;i<numberOfParts;i++)localvars[i]=document.getElementById("id_vars1_".concat(i)).value,answers[i]=document.getElementById("id_answer_".concat(i)).value;let pendingPromise=new _pending.default("qtype_formulas/instantiate");try{let response=await(0,_ajax.call)([{methodname:"qtype_formulas_instantiate",args:{n:howMany,randomvars:document.getElementById("id_varsrandom").value,globalvars:document.getElementById("id_varsglobal").value,localvars:localvars,answers:answers}}])[0];"error"==response.status?document.getElementById("qtextpreview_display").innerHTML=await String.get_string("previewerror","qtype_formulas",response.message):(document.getElementById("qtextpreview_display").innerHTML="",(data=>{let firstRow=data[0],calcOptions={bottomCalc:"stats",bottomCalcFormatter:cell=>cell.getValue().join("<br>")},columnDescription=[{title:"#",field:"id",bottomCalcFormatter:()=>"⌀<br>min</br>max"}],randomColumns=[];for(let column of firstRow.randomvars)randomColumns.push({title:column.name,field:"random_".concat(column.name),...calcOptions});randomColumns.length>0&&columnDescription.push({title:"Random variables",columns:randomColumns});let globalColumns=[];for(let column of firstRow.globalvars)globalColumns.push({title:column.name,field:"global_".concat(column.name),...calcOptions});globalColumns.length>0&&columnDescription.push({title:"Global variables",columns:globalColumns});let partColumns=[],partIndex=0;for(let part of firstRow.parts){let thisPartsColumns=[];for(let vars of part)thisPartsColumns.push({title:vars.name,field:"part_".concat(partIndex,"_").concat(vars.name),...calcOptions});partColumns.push({title:"Part ".concat(partIndex+1),columns:thisPartsColumns}),partIndex++}columnDescription=[...columnDescription,...partColumns],_tabulator.TabulatorFull.findTable("#varsdata_display")[0].setColumns(columnDescription),fillTable(data),localizeColumnGroupNames();let holders=document.querySelectorAll("div.tabulator-calcs-holder");for(let holder of holders)holder.style.display=data.length>1?"block":"none"})(response.data))}catch(err){Notification.exception(err)}pendingPromise.resolve()}};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=instantiation.min.js.map