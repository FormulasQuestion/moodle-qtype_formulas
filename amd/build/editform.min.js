define("qtype_formulas/editform",["exports","core/notification","core/pending","core/ajax","qtype_formulas/instantiation","core/str"],(function(_exports,Notification,_pending,_ajax,Instantiation,String){var obj;function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}
/**
   * Helper functions for the form used to create / edit a formulas question.
   *
   * @module     qtype_formulas/editform
   * @copyright  2022 Philipp Imhof
   * @author     Philipp Imhof
   * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=_exports.default=void 0,Notification=_interopRequireWildcard(Notification),_pending=(obj=_pending)&&obj.__esModule?obj:{default:obj},Instantiation=_interopRequireWildcard(Instantiation),String=_interopRequireWildcard(String);var defaultCorrectness="",numberOfParts=0,timer=null;var caretWarning="";const init=defCorrectness=>{defaultCorrectness=defCorrectness,numberOfParts=document.querySelectorAll("fieldset[id^='id_answerhdr_']").length,Instantiation.init(numberOfParts),fetchStrings();for(let i=0;i<numberOfParts;i++){let textfield=document.getElementById("id_correctness_".concat(i));0===i&&textfield.form.addEventListener("submit",reenableCriterionTextfields),textfield.addEventListener("input",blockModeSwitcherIfNeeded.bind(null,i));let checkbox=document.getElementById("id_correctness_simple_mode_".concat(i));checkbox.addEventListener("click",handleGradingCriterionModeSwitcher.bind(null,i)),checkbox.addEventListener("change",handleGradingCriterionModeSwitcher.bind(null,i)),textfield.dispatchEvent(new Event("input")),checkbox.disabled||textfield.classList.contains("is-invalid")||(checkbox.checked=!0,checkbox.dispatchEvent(new Event("click")));let elements=["type","comp","tol"];for(let element of elements)document.getElementById("id_correctness_simple_".concat(element,"_").concat(i)).addEventListener("change",handleSimpleCriterionChanges.bind(null,i));document.getElementById("id_correctness_simple_tol_".concat(i)).addEventListener("change",normalizeTolerance),document.getElementById("id_answer_".concat(i)).addEventListener("input",setDebounceTimer)}let variableFields=[{field:"random",handler:validateRandomvars},{field:"global",handler:validateGlobalvars}];for(let i=0;i<numberOfParts;i++)variableFields.push({field:"1_".concat(i),handler:validateLocalvars.bind(null,i)});for(let field of variableFields)document.getElementById("id_vars".concat(field.field)).addEventListener("blur",field.handler);document.getElementById("id_instantiatebtn").addEventListener("click",Instantiation.instantiate),"loading"!==document.readyState?disableSimpleModeIfError():document.addEventListener("DOMContentLoaded",disableSimpleModeIfError.bind(null))};_exports.init=init;const fetchStrings=async()=>{let pendingPromise=new _pending.default("qtype_formulas/editformstrings"),strings=null;try{strings=await String.get_strings([{key:"caretwarning",component:"qtype_formulas"}])}catch(err){Notification.exception(err)}pendingPromise.resolve(),null!==strings&&(caretWarning=strings[0])},setDebounceTimer=evt=>{"number"==typeof timer&&clearTimeout(timer),timer=setTimeout(warnAboutCaret,250,evt.target.id)},disableSimpleModeIfError=()=>{for(let i=0;i<numberOfParts;i++)""!==document.getElementById("id_error_correctness_".concat(i)).innerText.trim()&&(document.getElementById("id_correctness_simple_mode_".concat(i)).checked=!1)},validateGlobalvars=async evt=>{if(""===evt.target.value)return void showOrClearValidationError(evt.target.id,"");let pendingPromise=new _pending.default("qtype_formulas/validateglobal");try{let validationResult=await(0,_ajax.call)([{methodname:"qtype_formulas_check_random_global_vars",args:{randomvars:document.getElementById("id_varsrandom").value,globalvars:evt.target.value}}])[0];""===validationResult.source||"global"===validationResult.source?showOrClearValidationError(evt.target.id,validationResult.message):showOrClearValidationError("id_varsrandom",validationResult.message,!1)}catch(err){Notification.exception(err)}pendingPromise.resolve()},validateRandomvars=async evt=>{if(""===evt.target.value)return void showOrClearValidationError(evt.target.id,"");let pendingPromise=new _pending.default("qtype_formulas/validaterandom");try{let validationResult=await(0,_ajax.call)([{methodname:"qtype_formulas_check_random_global_vars",args:{randomvars:evt.target.value}}])[0];showOrClearValidationError(evt.target.id,validationResult.message)}catch(err){Notification.exception(err)}pendingPromise.resolve()},validateLocalvars=async part=>{let fieldList={random:"id_varsrandom",global:"id_varsglobal",local:"id_vars1_".concat(part)},target=document.getElementById(fieldList.local);if(""===target.value)return void showOrClearValidationError(target.id,"");let pendingPromise=new _pending.default("qtype_formulas/validatelocal");try{let validationResult=await(0,_ajax.call)([{methodname:"qtype_formulas_check_local_vars",args:{randomvars:document.getElementById(fieldList.random).value,globalvars:document.getElementById(fieldList.global).value,localvars:target.value}}])[0];""===validationResult.source&&(validationResult.source="local"),showOrClearValidationError(fieldList[validationResult.source],validationResult.message,"local"===validationResult.source)}catch(err){Notification.exception(err)}pendingPromise.resolve()},showOrClearValidationError=function(fieldID,message){let sameField=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],field=document.getElementById(fieldID),annotation=document.getElementById(fieldID.replace(/^id_(.*)$/,"id_error_$1")),alreadyWithError=""!==annotation.innerText.trim();if(""===message)return annotation.innerText="",void field.classList.remove("is-invalid");if(annotation.innerText=message.replaceAll("-1:",""),field.classList.add("is-invalid"),!alreadyWithError||!sameField){field.focus();let messageParts=message.split(":",2);if(messageParts.length<2)return;let row=parseInt(messageParts[0]),col=parseInt(messageParts[1]);jumpToRowAndColumn(field,row,col)}},warnAboutCaret=id=>{if(""===caretWarning)return;let field=document.getElementById(id),annotation=document.getElementById(id.replace(/^id_(.*)$/,"id_error_$1"));if(field.value.includes("^")){if(""!==annotation.innerText.trim())return;annotation.innerText=caretWarning,annotation.style.display="block"}else{if(annotation.innerText!==caretWarning)return;annotation.innerText="",annotation.style.display=""}},jumpToRowAndColumn=(field,row,col)=>{let lines=field.value.split("\n");if(-1==row||-1==col)return;let cursorPosition=0;for(let i=0;i<row-1&&!(i>=lines.length);i++)cursorPosition+=lines[i].length+1;cursorPosition+=Math.max(0,Math.min(col-1,lines[row-1].length)),field.focus(),field.setSelectionRange(cursorPosition,cursorPosition)},reenableCriterionTextfields=()=>{for(let i=0;i<numberOfParts;i++)document.getElementById("id_correctness_".concat(i)).disabled=!1},handleSimpleCriterionChanges=partNumber=>{document.getElementById("id_correctness_".concat(partNumber)).value=convertSimpleCriterionToText(partNumber)},normalizeTolerance=event=>{let field=event.target,tolerance=parseFloat(field.value);!isNaN(tolerance)&&isFinite(tolerance)||(tolerance=0),field.value=tolerance},handleGradingCriterionModeSwitcher=partNumber=>{let checkbox=document.getElementById("id_correctness_simple_mode_".concat(partNumber)),criterionTextfield=document.getElementById("id_correctness_".concat(partNumber));if(!checkbox.checked)return void(criterionTextfield.value=convertSimpleCriterionToText(partNumber));""==criterionTextfield.value.trim()&&(criterionTextfield.value=defaultCorrectness);let simpleCriterion=convertTextCriterionToSimple(partNumber);document.getElementById("id_correctness_simple_type_".concat(partNumber)).value=simpleCriterion.type,document.getElementById("id_correctness_simple_comp_".concat(partNumber)).value=simpleCriterion.comparison,document.getElementById("id_correctness_simple_tol_".concat(partNumber)).value=simpleCriterion.tolerance},convertSimpleCriterionToText=partNumber=>{let typeElement=document.getElementById("id_correctness_simple_type_".concat(partNumber)),comparisonElement=document.getElementById("id_correctness_simple_comp_".concat(partNumber)),toleranceElement=document.getElementById("id_correctness_simple_tol_".concat(partNumber));return["_relerr","_err"][typeElement.value]+" "+comparisonElement.options[comparisonElement.value].innerText+" "+parseFloat(toleranceElement.value)},convertTextCriterionToSimple=partNumber=>{let criterionParts=document.getElementById("id_correctness_".concat(partNumber)).value.split(/\s*(==|<)\s*/);if(3!=criterionParts.length||!criterionParts[0].match(/^\s*_(rel)?err\s*$/))throw new TypeError("The given grading criterion cannot be shown in simple mode.");return{type:["_relerr","_err"].indexOf(criterionParts[0]),comparison:["==","<"].indexOf(criterionParts[1]),tolerance:parseFloat(criterionParts[2])}},blockModeSwitcherIfNeeded=partNumber=>{let criterion=document.getElementById("id_correctness_".concat(partNumber)).value.trim(),modeCheckbox=document.getElementById("id_correctness_simple_mode_".concat(partNumber));if(""==criterion)return void(modeCheckbox.disabled=!1);let criterionParts=criterion.split(/\s*(==|<)\s*/);if(3!=criterionParts.length)return void(modeCheckbox.disabled=!0);if(!criterionParts[0].match(/^\s*_(rel)?err\s*$/))return void(modeCheckbox.disabled=!0);if(!criterionParts[1].match(/\s*(==|<)\s*$/))return void(modeCheckbox.disabled=!0);let tolerance=parseFloat(criterionParts[2]);isNaN(tolerance)||!isFinite(tolerance)||criterionParts[2].match(/[^-+0-9.e]/)?modeCheckbox.disabled=!0:modeCheckbox.disabled=!1};var _default={init:init};return _exports.default=_default,_exports.default}));

//# sourceMappingURL=editform.min.js.map